<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yapper</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --imessage-blue: linear-gradient(180deg, #00D2FF 0%, #007AFF 100%);
            --bg-main: #ffffff;
            --text-dark: #000000;
            --text-gray: #8E8E93;
            --bubble-received: #E9E9EB;
            --border: #C6C6C8;
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        [data-theme="dark"] {
            --bg-main: #000000; --text-dark: #ffffff; --text-gray: #98989D;
            --bubble-received: #1C1C1E; --border: #38383A;
        }

        /* Prevent Text Highlighting & Copying */
        * { 
            -webkit-tap-highlight-color: transparent; 
            box-sizing: border-box; 
            -webkit-user-select: none;
            user-select: none;
        }
        input { -webkit-user-select: text; user-select: text; }

        body, html { margin: 0; padding: 0; height: 100dvh; font-family: var(--ios-font); background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        
        .view { display: none; flex-direction: column; height: 100%; width: 100%; max-width: 600px; margin: 0 auto; background: var(--bg-main); }

        /* Header */
        .header { padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid var(--border); height: 64px; z-index: 10; }

        /* Reaction Pop-up */
        #reaction-menu {
            position: fixed; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 30px; padding: 10px 18px; display: none; gap: 12px; z-index: 2000;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); border: 0.5px solid var(--border);
            transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #reaction-menu.active { display: flex; transform: scale(1); }
        .react-opt { font-size: 26px; cursor: pointer; transition: transform 0.1s; }
        .react-opt:hover { transform: scale(1.3); }

        /* Messages */
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 4px; }
        .msg-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; width: 100%; position: relative; }
        .msg-row.sent { flex-direction: row-reverse; }

        /* PC Trigger */
        .pc-trigger { opacity: 0; cursor: pointer; color: var(--text-gray); font-size: 18px; transition: 0.2s; padding: 5px; }
        .msg-row:hover .pc-trigger { opacity: 1; }
        @media (max-width: 768px) { .pc-trigger { display: none; } }

        .msg { 
            max-width: 75%; padding: 10px 16px; font-size: 16px; border-radius: 20px; 
            line-height: 1.3; position: relative; cursor: pointer;
        }
        .sent .msg { background: var(--imessage-blue); color: white; border-bottom-right-radius: 4px; }
        .received .msg { background: var(--bubble-received); color: var(--text-dark); border-bottom-left-radius: 4px; }

        .reaction-badge {
            position: absolute; bottom: -10px; right: 10px;
            background: white; border-radius: 15px; padding: 2px 6px;
            font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 0.5px solid #ddd;
        }
        .received .reaction-badge { left: 10px; right: auto; }

        /* Compose */
        .compose-bar { padding: 10px 12px 34px 12px; display: flex; align-items: center; gap: 10px; border-top: 0.5px solid var(--border); }
        .input-wrapper { flex: 1; border: 0.5px solid var(--border); border-radius: 25px; padding: 8px 16px; }
        .msg-input { width: 100%; border: none; background: transparent; outline: none; font-size: 16px; color: var(--text-dark); }
        .send-btn { width: 32px; height: 32px; background: #007AFF; border: none; border-radius: 50%; color: white; font-size: 20px; }
    </style>
</head>
<body data-theme="light">

    <div id="reaction-menu">
        <span class="react-opt" onclick="applyReaction('üòÇ')">üòÇ</span>
        <span class="react-opt" onclick="applyReaction('üò¢')">üò¢</span>
        <span class="react-opt" onclick="applyReaction('üòÆ')">üòÆ</span>
        <span class="react-opt" onclick="applyReaction('üò°')">üò°</span>
        <span class="react-opt" onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
    </div>

    <div id="home-view" class="view" style="display:flex;">
        <div class="header">
            <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:22px;">üåì</button>
            <div style="font-weight:700; font-size:24px;">Yapper</div>
            <div style="width:24px;"></div>
        </div>
        <div id="friend-list"></div>
    </div>

    <div id="chat-view" class="view">
        <div class="header">
            <button id="btn-back" style="background:none; border:none; color:#007AFF; font-size:17px;">‚Äπ Back</button>
            <div id="chat-target-name" style="font-weight:600;">Contact</div>
            <div style="width:40px;"></div>
        </div>
        <div id="messages" onclick="closeMenu()"></div>
        <div class="compose-bar">
            <div class="input-wrapper"><input type="text" id="msg-input" class="msg-input" placeholder="Yapper" autocomplete="off"></div>
            <button id="btn-send" class="send-btn">‚Üë</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA", authDomain: "messengerapp-dcccc.firebaseapp.com", projectId: "messengerapp-dcccc", storageBucket: "messengerapp-dcccc.firebasestorage.app", messagingSenderId: "255835922798", appId: "1:255835922798:web:d9293fc275ae2b18fa617f" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

        let activeChatId = null, selectedMsgId = null, pressTimer = null;

        // Interaction logic
        window.startPress = (id, e) => { pressTimer = setTimeout(() => openMenu(id, e), 500); };
        window.endPress = () => clearTimeout(pressTimer);
        window.openMenu = (id, e) => {
            selectedMsgId = id; const menu = document.getElementById('reaction-menu');
            const pos = e.touches ? e.touches[0] : e;
            menu.style.top = (pos.clientY - 70) + "px";
            menu.style.left = Math.max(10, Math.min(window.innerWidth - 220, pos.clientX - 100)) + "px";
            menu.classList.add('active');
            if(navigator.vibrate) navigator.vibrate(40);
        };
        window.closeMenu = () => document.getElementById('reaction-menu').classList.remove('active');
        window.applyReaction = async (emoji) => {
            if(selectedMsgId && activeChatId) {
                await updateDoc(doc(db, "chats", activeChatId, "messages", selectedMsgId), { reaction: emoji });
                closeMenu();
            }
        };

        // UI Logic
        function loadMessages(roomId) {
            onSnapshot(query(collection(db, "chats", roomId, "messages"), orderBy("timestamp", "asc")), snap => {
                const div = document.getElementById('messages'); div.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data(); const isSent = m.sender === auth.currentUser.uid;
                    const row = document.createElement('div'); row.className = `msg-row ${isSent?'sent':'received'}`;
                    row.innerHTML = `
                        <div class="pc-trigger" onclick="openMenu('${d.id}', event)">‚ò∫</div>
                        <div class="msg" onmousedown="startPress('${d.id}', event)" onmouseup="endPress()" ontouchstart="startPress('${d.id}', event)" ontouchend="endPress()">
                            ${m.text}${m.reaction ? `<div class="reaction-badge">${m.reaction}</div>` : ''}
                        </div>`;
                    div.appendChild(row);
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        // Auth & Helpers
        onAuthStateChanged(auth, user => { if(user) loadFriends(); });
        document.getElementById('btn-send').onclick = () => {
            const i = document.getElementById('msg-input');
            if(i.value.trim() && activeChatId) {
                addDoc(collection(db, "chats", activeChatId, "messages"), { text: i.value, sender: auth.currentUser.uid, timestamp: serverTimestamp() });
                i.value = '';
            }
        };
        window.toggleDarkMode = () => {
            const t = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', t);
        };
        document.getElementById('btn-back').onclick = () => { document.getElementById('chat-view').style.display='none'; document.getElementById('home-view').style.display='flex'; };
    </script>
</body>
</html>
